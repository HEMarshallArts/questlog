<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoQuest - Dark Souls Task Manager</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Philosopher:ital,wght@0,400;0,700;1,400&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons as React Components (inline)
        const Scroll = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/><path d="M15 8h-5"/><path d="M15 12h-5"/>
            </svg>
        );

        const Swords = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" x2="9" y1="14" y2="18"/><line x1="7" x2="4" y1="17" y2="20"/><line x1="3" x2="5" y1="19" y2="21"/>
            </svg>
        );

        const Flame = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
            </svg>
        );

        const ChevronDown = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m6 9 6 6 6-6"/>
            </svg>
        );

        const ChevronRight = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m9 18 6-6-6-6"/>
            </svg>
        );

        const Plus = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12h14"/><path d="M12 5v14"/>
            </svg>
        );

        const X = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
            </svg>
        );

        function TodoQuest() {
            const [quests, setQuests] = useState([]);
            const [taskInput, setTaskInput] = useState('');
            const [category, setCategory] = useState('Main');
            const [subtasks, setSubtasks] = useState(['']);
            const [isLoading, setIsLoading] = useState(false);
            const [expandedQuests, setExpandedQuests] = useState(new Set());
            const [apiKey, setApiKey] = useState('');
            const [showApiKeyInput, setShowApiKeyInput] = useState(false);

            useEffect(() => {
                const savedKey = localStorage.getItem('anthropic_api_key');
                if (savedKey) {
                    setApiKey(savedKey);
                }
            }, []);

            const saveApiKey = (key) => {
                localStorage.setItem('anthropic_api_key', key);
                setApiKey(key);
                setShowApiKeyInput(false);
            };

            const transformQuest = async (task, taskSubtasks = []) => {
                if (!apiKey) {
                    alert('Please set your Anthropic API key first!');
                    setShowApiKeyInput(true);
                    throw new Error('API key not configured');
                }

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 2000,
                        messages: [{
                            role: "user",
                            content: `Transform this mundane task into a Dark Souls-style quest. Use cryptic, ominous language with medieval/fantasy terminology. Be creative and dramatic, but keep the core task recognizable.

Task: "${task}"
${taskSubtasks.length > 0 ? `Subtasks: ${taskSubtasks.map((st, i) => `${i + 1}. ${st}`).join(', ')}` : ''}

Respond ONLY with valid JSON in this exact format (no other text, no markdown):
{
  "questTitle": "The [Mysterious Title]",
  "description": "A 2-3 sentence ominous description in Dark Souls style, addressing the player as 'ashen one', 'hollowed one', or similar, describing the task as a grim ritual or dark journey",
  "reward": "What you gain upon completion, described mysteriously"${taskSubtasks.length > 0 ? `,
  "steps": ["Step 1 transformed into dark fantasy", "Step 2 transformed", etc.]` : ''}
}

DO NOT include any text outside the JSON. Your entire response must be valid JSON only.`
                        }]
                    })
                });

                const data = await response.json();
                let responseText = data.content[0].text;
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                return JSON.parse(responseText);
            };

            const addQuest = async () => {
                if (!taskInput.trim()) return;

                setIsLoading(true);
                try {
                    const validSubtasks = subtasks.filter(st => st.trim());
                    const transformed = await transformQuest(taskInput, validSubtasks);

                    const newQuest = {
                        id: Date.now(),
                        category,
                        originalTask: taskInput,
                        ...transformed,
                        completed: false,
                        stepsCompleted: transformed.steps ? Array(transformed.steps.length).fill(false) : []
                    };

                    setQuests([newQuest, ...quests]);
                    setTaskInput('');
                    setSubtasks(['']);
                    setExpandedQuests(new Set([newQuest.id, ...expandedQuests]));
                } catch (error) {
                    console.error('Quest transformation failed:', error);
                    alert('The dark magic faltered. Please try again.');
                }
                setIsLoading(false);
            };

            const toggleQuest = (id) => {
                setQuests(quests.map(q =>
                    q.id === id ? { ...q, completed: !q.completed } : q
                ));
            };

            const toggleStep = (questId, stepIndex) => {
                setQuests(quests.map(q => {
                    if (q.id === questId) {
                        const newStepsCompleted = [...q.stepsCompleted];
                        newStepsCompleted[stepIndex] = !newStepsCompleted[stepIndex];
                        return { ...q, stepsCompleted: newStepsCompleted };
                    }
                    return q;
                }));
            };

            const deleteQuest = (id) => {
                setQuests(quests.filter(q => q.id !== id));
            };

            const toggleExpanded = (id) => {
                const newExpanded = new Set(expandedQuests);
                if (newExpanded.has(id)) {
                    newExpanded.delete(id);
                } else {
                    newExpanded.add(id);
                }
                setExpandedQuests(newExpanded);
            };

            const addSubtaskField = () => {
                setSubtasks([...subtasks, '']);
            };

            const updateSubtask = (index, value) => {
                const newSubtasks = [...subtasks];
                newSubtasks[index] = value;
                setSubtasks(newSubtasks);
            };

            const removeSubtask = (index) => {
                setSubtasks(subtasks.filter((_, i) => i !== index));
            };

            const getCategoryIcon = (cat) => {
                if (cat === 'Daily') return <Flame />;
                if (cat === 'Main') return <Swords />;
                return <Scroll />;
            };

            const questsByCategory = {
                Daily: quests.filter(q => q.category === 'Daily'),
                Main: quests.filter(q => q.category === 'Main'),
                Optional: quests.filter(q => q.category === 'Optional')
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-amber-950 via-stone-900 to-black text-gray-100 p-6" style={{ fontFamily: 'Philosopher, serif' }}>
                    <div className="max-w-4xl mx-auto">
                        {/* API Key Modal */}
                        {showApiKeyInput && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                                <div className="bg-gradient-to-br from-amber-900/90 to-stone-900 border-4 border-amber-700 rounded-lg p-6 max-w-md w-full">
                                    <h3 className="text-2xl font-bold text-amber-400 mb-4" style={{ fontFamily: 'Cinzel, serif' }}>
                                        Enter Anthropic API Key
                                    </h3>
                                    <p className="text-amber-200 mb-4 text-sm" style={{ fontFamily: 'Philosopher, serif' }}>
                                        Get your API key from <a href="https://console.anthropic.com/" target="_blank" className="text-amber-400 underline">console.anthropic.com</a>
                                    </p>
                                    <input
                                        type="password"
                                        placeholder="sk-ant-..."
                                        className="w-full bg-stone-950 border-2 border-amber-900 rounded px-4 py-2 text-amber-100 mb-4"
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                saveApiKey(e.target.value);
                                            }
                                        }}
                                    />
                                    <div className="flex gap-2">
                                        <button
                                            onClick={(e) => {
                                                const input = e.target.parentElement.previousElementSibling;
                                                saveApiKey(input.value);
                                            }}
                                            className="flex-1 bg-amber-800 hover:bg-amber-700 text-amber-100 py-2 rounded border-2 border-amber-600"
                                            style={{ fontFamily: 'Cinzel, serif' }}
                                        >
                                            Save
                                        </button>
                                        <button
                                            onClick={() => setShowApiKeyInput(false)}
                                            className="px-4 bg-stone-800 hover:bg-stone-700 text-gray-300 py-2 rounded border-2 border-stone-600"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Header */}
                        <div className="fixed top-4 left-4 text-amber-700 opacity-30 text-6xl" style={{ fontFamily: 'Uncial Antiqua, cursive' }}>✦</div>
                        <div className="fixed top-4 right-4 text-amber-700 opacity-30 text-6xl" style={{ fontFamily: 'Uncial Antiqua, cursive' }}>✦</div>

                        <div className="text-center mb-8 border-b-2 border-amber-800 pb-6 relative">
                            <div className="absolute top-2 right-2">
                                <button
                                    onClick={() => setShowApiKeyInput(true)}
                                    className="text-xs text-amber-600 hover:text-amber-400 underline"
                                    style={{ fontFamily: 'Cinzel, serif' }}
                                >
                                    {apiKey ? '🔑 Change API Key' : '🔑 Set API Key'}
                                </button>
                            </div>
                            <div className="absolute inset-0 bg-gradient-to-b from-amber-950/20 to-transparent rounded-t-lg"></div>
                            <div className="flex items-center justify-center gap-3 mb-2 relative">
                                <div className="w-10 h-10 text-amber-600"><Scroll /></div>
                                <h1 className="text-5xl font-bold text-amber-500 tracking-widest" style={{ fontFamily: 'Cinzel, serif', textShadow: '2px 2px 4px rgba(0,0,0,0.8)' }}>
                                    TODOQUEST
                                </h1>
                                <div className="w-10 h-10 text-amber-600"><Scroll /></div>
                            </div>
                            <p className="text-amber-700 italic text-lg relative" style={{ fontFamily: 'Philosopher, serif' }}>~ Thy Tasks, Forged in Shadow ~</p>
                            <div className="mt-3 flex justify-center gap-3 text-amber-800">
                                <span style={{ fontFamily: 'Uncial Antiqua, cursive' }}>⚜</span>
                                <span style={{ fontFamily: 'Uncial Antiqua, cursive' }}>⚜</span>
                                <span style={{ fontFamily: 'Uncial Antiqua, cursive' }}>⚜</span>
                            </div>
                        </div>

                        {/* Add Quest Form */}
                        <div className="bg-gradient-to-br from-amber-900/30 to-stone-900/50 border-4 border-amber-900/50 rounded-lg p-6 mb-8 shadow-2xl relative">
                            <h2 className="text-2xl font-semibold text-amber-400 mb-4" style={{ fontFamily: 'Cinzel, serif', textShadow: '1px 1px 2px rgba(0,0,0,0.8)' }}>
                                ⟨ Inscribe a New Quest ⟩
                            </h2>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm text-amber-600 mb-2" style={{ fontFamily: 'Cinzel, serif', letterSpacing: '1px' }}>Quest Type</label>
                                    <div className="flex gap-2">
                                        {['Daily', 'Main', 'Optional'].map(cat => (
                                            <button
                                                key={cat}
                                                onClick={() => setCategory(cat)}
                                                className={`flex items-center gap-2 px-4 py-2 rounded transition-all border-2 ${category === cat
                                                        ? 'bg-amber-800 text-amber-100 border-amber-600 shadow-lg'
                                                        : 'bg-stone-800/60 text-amber-700 border-stone-700 hover:bg-stone-700/60'
                                                    }`}
                                                style={{ fontFamily: 'Cinzel, serif' }}
                                            >
                                                <div className="w-4 h-4">{getCategoryIcon(cat)}</div>
                                                <span>{cat}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm text-amber-600 mb-2" style={{ fontFamily: 'Cinzel, serif', letterSpacing: '1px' }}>Task Description</label>
                                    <input
                                        type="text"
                                        value={taskInput}
                                        onChange={(e) => setTaskInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && !isLoading && addQuest()}
                                        placeholder="Enter your mundane task..."
                                        className="w-full bg-stone-950/70 border-2 border-amber-900/50 rounded px-4 py-3 text-amber-100 placeholder-amber-900/50 focus:outline-none focus:border-amber-700 shadow-inner"
                                        style={{ fontFamily: 'Philosopher, serif', fontSize: '16px' }}
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm text-amber-600 mb-2" style={{ fontFamily: 'Cinzel, serif', letterSpacing: '1px' }}>Quest Steps (Optional)</label>
                                    {subtasks.map((subtask, index) => (
                                        <div key={index} className="flex gap-2 mb-2">
                                            <input
                                                type="text"
                                                value={subtask}
                                                onChange={(e) => updateSubtask(index, e.target.value)}
                                                placeholder={`Step ${index + 1}...`}
                                                className="flex-1 bg-stone-950/70 border-2 border-amber-900/50 rounded px-4 py-2 text-amber-100 placeholder-amber-900/50 focus:outline-none focus:border-amber-700 shadow-inner"
                                                style={{ fontFamily: 'Philosopher, serif' }}
                                            />
                                            {subtasks.length > 1 && (
                                                <button
                                                    onClick={() => removeSubtask(index)}
                                                    className="px-3 py-2 bg-red-950/80 hover:bg-red-900/80 rounded transition-colors border-2 border-red-900"
                                                >
                                                    <div className="w-4 h-4"><X /></div>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    <button
                                        onClick={addSubtaskField}
                                        className="text-amber-500 hover:text-amber-400 text-sm flex items-center gap-1 mt-2"
                                        style={{ fontFamily: 'Cinzel, serif' }}
                                    >
                                        <div className="w-4 h-4"><Plus /></div>
                                        Add Step
                                    </button>
                                </div>

                                <button
                                    onClick={addQuest}
                                    disabled={isLoading || !taskInput.trim()}
                                    className={`w-full py-3 rounded font-semibold transition-all border-2 ${isLoading || !taskInput.trim()
                                            ? 'bg-stone-800 text-stone-600 cursor-not-allowed border-stone-700'
                                            : 'bg-amber-800 hover:bg-amber-700 text-amber-100 border-amber-600 shadow-lg hover:shadow-xl'
                                        }`}
                                    style={{ fontFamily: 'Cinzel, serif', letterSpacing: '2px', textShadow: '1px 1px 2px rgba(0,0,0,0.5)' }}
                                >
                                    {isLoading ? '⟨ Channeling Dark Magic ⟩' : '⟨ FORGE QUEST ⟩'}
                                </button>
                            </div>
                        </div>

                        {/* Quest Log */}
                        <div className="space-y-6">
                            {['Daily', 'Main', 'Optional'].map(cat => (
                                questsByCategory[cat].length > 0 && (
                                    <div key={cat}>
                                        <h3 className="text-3xl font-bold text-amber-500 mb-4 flex items-center gap-3 border-b-2 border-amber-900/50 pb-2" style={{ fontFamily: 'Cinzel, serif', textShadow: '2px 2px 4px rgba(0,0,0,0.8)' }}>
                                            <div className="w-6 h-6">{getCategoryIcon(cat)}</div>
                                            <span>{cat} Quests</span>
                                            <span className="text-amber-800" style={{ fontFamily: 'Uncial Antiqua, cursive' }}>⚜</span>
                                        </h3>
                                        <div className="space-y-4">
                                            {questsByCategory[cat].map(quest => (
                                                <div
                                                    key={quest.id}
                                                    className={`bg-gradient-to-br from-amber-900/20 to-stone-900/40 border-4 rounded-lg overflow-hidden transition-all shadow-xl relative ${quest.completed
                                                            ? 'border-green-900/50 opacity-60'
                                                            : 'border-amber-900/60 hover:border-amber-800/80 hover:shadow-2xl'
                                                        }`}
                                                >
                                                    <div className="absolute top-2 left-2 text-amber-800/20 text-4xl" style={{ fontFamily: 'Uncial Antiqua, cursive' }}>❦</div>
                                                    <div className="absolute bottom-2 right-2 text-amber-800/20 text-4xl" style={{ fontFamily: 'Uncial Antiqua, cursive' }}>❦</div>

                                                    <div className="p-6 relative z-10">
                                                        <div className="flex items-start gap-3">
                                                            <input
                                                                type="checkbox"
                                                                checked={quest.completed}
                                                                onChange={() => toggleQuest(quest.id)}
                                                                className="mt-1 w-5 h-5 cursor-pointer accent-amber-700"
                                                            />
                                                            <div className="flex-1">
                                                                <div className="flex items-start justify-between gap-2 mb-3">
                                                                    <h4 className={`text-xl font-bold ${quest.completed ? 'line-through text-gray-600' : 'text-amber-400'
                                                                        }`} style={{ fontFamily: 'Cinzel, serif', textShadow: '1px 1px 2px rgba(0,0,0,0.8)', letterSpacing: '0.5px' }}>
                                                                        {quest.questTitle}
                                                                    </h4>
                                                                    <button
                                                                        onClick={() => deleteQuest(quest.id)}
                                                                        className="text-red-600 hover:text-red-500 transition-colors"
                                                                    >
                                                                        <div className="w-5 h-5"><X /></div>
                                                                    </button>
                                                                </div>
                                                                <p className={`text-base mb-4 leading-relaxed ${quest.completed ? 'text-gray-600' : 'text-amber-200/90'
                                                                    }`} style={{ fontFamily: 'Philosopher, serif', fontStyle: 'italic' }}>
                                                                    {quest.description}
                                                                </p>
                                                                <div className="flex items-center gap-2 text-sm bg-stone-950/60 px-4 py-3 rounded border-2 border-amber-900/40 shadow-inner">
                                                                    <span className="font-semibold text-amber-600" style={{ fontFamily: 'Cinzel, serif' }}>⚔ Reward:</span>
                                                                    <span className="text-amber-300/90" style={{ fontFamily: 'Philosopher, serif' }}>{quest.reward}</span>
                                                                </div>

                                                                {quest.steps && quest.steps.length > 0 && (
                                                                    <div className="mt-4 pt-4 border-t-2 border-amber-900/30">
                                                                        <button
                                                                            onClick={() => toggleExpanded(quest.id)}
                                                                            className="flex items-center gap-2 text-sm text-amber-500 hover:text-amber-400 transition-colors"
                                                                            style={{ fontFamily: 'Cinzel, serif' }}
                                                                        >
                                                                            <div className="w-4 h-4">
                                                                                {expandedQuests.has(quest.id) ? <ChevronDown /> : <ChevronRight />}
                                                                            </div>
                                                                            <span className="font-semibold">
                                                                                ⟨ Quest Steps: {quest.stepsCompleted.filter(Boolean).length}/{quest.steps.length} ⟩
                                                                            </span>
                                                                        </button>

                                                                        {expandedQuests.has(quest.id) && (
                                                                            <div className="mt-3 space-y-3 pl-6 border-l-4 border-amber-900/40">
                                                                                {quest.steps.map((step, index) => (
                                                                                    <div key={index} className="flex items-start gap-3 bg-stone-950/40 p-3 rounded border border-amber-900/20">
                                                                                        <input
                                                                                            type="checkbox"
                                                                                            checked={quest.stepsCompleted[index]}
                                                                                            onChange={() => toggleStep(quest.id, index)}
                                                                                            className="mt-1 w-4 h-4 cursor-pointer accent-amber-700"
                                                                                        />
                                                                                        <span className={`text-sm ${quest.stepsCompleted[index]
                                                                                                ? 'line-through text-gray-600'
                                                                                                : 'text-amber-200/80'
                                                                                            }`} style={{ fontFamily: 'Philosopher, serif' }}>
                                                                                            {step}
                                                                                        </span>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )
                            ))}

                            {quests.length === 0 && (
                                <div className="text-center py-16 text-amber-700/60">
                                    <div className="w-20 h-20 mx-auto mb-4 opacity-40"><Scroll /></div>
                                    <p className="text-2xl italic mb-2" style={{ fontFamily: 'Cinzel, serif' }}>The Quest Log Lies Empty...</p>
                                    <p className="text-base mt-3" style={{ fontFamily: 'Philosopher, serif' }}>Inscribe thy first quest above to begin thy dark journey</p>
                                    <div className="mt-4 flex justify-center gap-4 text-3xl opacity-30" style={{ fontFamily: 'Uncial Antiqua, cursive' }}>
                                        <span>⚜</span>
                                        <span>❦</span>
                                        <span>⚜</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TodoQuest />, document.getElementById('root'));
    </script>
</body>
</html>